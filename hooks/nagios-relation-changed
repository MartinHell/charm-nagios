#!/usr/bin/env python

import string
import sys
import os
import yaml
import subprocess
import socket

from Cheetah.Template import Template

def write_service_template(service, host, description, command):
        service = service.replace("__hostname__", host)
        service = service.replace("__description__", description)
        service = service.replace("__command__", command)
        return service

def write_host_template(host, hostname, ip_address):
        host = host.replace("__hostname__", hostname)
        host = host.replace("__alias__", hostname)
        host = host.replace("__address__", ip_address)
        return host


def check_ip(n):
    try:
        socket.inet_pton(socket.AF_INET, n)
        return True
    except socket.error:
        try:
            socket.inet_pton(socket.AF_INET6, n)
            return True
        except socket.error:
            return False


def main():
        if 'JUJU_REMOTE_UNIT' not in os.environ:
            print "JUJU_REMOTE_UNIT must be set"
            return 1
        remote_unit = os.environ["JUJU_REMOTE_UNIT"]
        service_name, _ = remote_unit.split("/")

        p = subprocess.Popen(["relation-get", "private-address"],
                             stdout=subprocess.PIPE)
        hostname=p.stdout.read().strip()
        if hostname is None or not len(hostname):
            print "relation-get failed"
            return 2
        if check_ip(hostname):
            # Some providers don't provide hostnames, so use the remote unit name.
            ip_address = hostname
            hostname = remote_unit.replace('/','-')
        else:
            ip_address = socket.getaddrinfo(hostname, None)[0][4][0]

        nagios_service = ""
        host_template = """
        define host {
                use            generic-host    ; Name of host template to use
                host_name      __hostname__
                alias          __alias__
                address        __address__
        }
"""
        service_template = """
        define service {
                use                     generic-service    ; Name of service template to use
                host_name                               __hostname__
                service_description             __description__
                check_command                   __command__
        }
"""

        f = open("templates/config.yaml", 'r')
        config = yaml.load(f)

        # write a single host
        host_template = write_host_template(host_template, hostname, ip_address)
        nagios_service += host_template

        for formula in config['juju']['charms'].keys():
                if service_name in formula:
                        nagios_plugins = config['juju']['charms'][formula]['plugins']

        for plugins in nagios_plugins.split():
                nagios_desc = config['juju']['plugins'][plugins]['desc']
                nagios_service += write_service_template(service_template, hostname, nagios_desc, plugins)

        namespace = {'hostname': hostname, 'nagios_config':nagios_service}
        t = Template(open('templates/nagios.tmpl').read(), searchList=[namespace])
        config_file = "/etc/nagios3/conf.d/%s-config.cfg" %hostname
        f = open(config_file, 'w')
        f.write(str(t))
        f.close()

        print "Restarting nagios"
        subprocess.call(["service", "nagios3", "restart"])
        return 0

if __name__ == '__main__':
        sys.exit(main())


